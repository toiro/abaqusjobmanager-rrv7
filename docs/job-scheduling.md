# ジョブスケジューリング仕様

## 概要

Abaqus Job Managerのジョブスケジューリングシステムは、複数のAbaqusノードに対してジョブを効率的に分散実行するための仕組みです。

## スケジューリング戦略

### 1. 基本原則

- **ユーザー指定ノード**: ジョブ作成時にユーザーが実行ノードを指定
- **FIFO (First In, First Out)**: ノード内では作成日時順で実行
- **優先度考慮**: 同一ノード内で優先度が高いジョブを優先実行
- **リソース制限**: 各ノードの同時実行数制限を遵守
- **ノード待機**: 指定ノードが満負荷の場合は待機継続

### 2. スケジューリングアルゴリズム

```
1. ノード別に実行待ちジョブを取得
   - 各ノードに対して指定されたジョブを取得
   - ステータスが "Waiting" のジョブ
   - 優先度降順、作成日時昇順でソート

2. ノード毎に実行可能性をチェック
   - ノードステータスが "Available"
   - 現在実行中のジョブ数 < max_concurrent
   - SSH接続が可能

3. 実行可能なジョブから実行開始
   - 各ノードの空きスロット数分まで実行
   - 指定ノードが利用不可の場合は待機継続

4. ジョブ実行開始
   - ステータスを "Starting" に更新
   - 指定されたノードでAbaqus実行プロセスを開始
```

## ノード管理

### 1. ノード状態

| 状態 | 説明 | 設定方法 |
|------|------|----------|
| Available | 利用可能（ジョブ実行可能） | ヘルスチェック成功時に自動設定 |
| Busy | 満負荷（新規ジョブ受付不可） | 同時実行数上限到達時に自動設定 |
| Unavailable | 利用不可（SSH接続不可等） | 初期状態、または接続失敗時に自動設定 |

**注意**: メンテナンス時は `is_active=false` を使用してノードを無効化

### 2. ノード指定によるジョブキュー管理

```sql
-- 指定ノードの実行待ちジョブを取得
SELECT j.*, n.status as node_status, 
       COALESCE(running_jobs.count, 0) as node_current_jobs,
       n.max_concurrent
FROM jobs j
JOIN nodes n ON j.node_id = n.id
LEFT JOIN (
    SELECT node_id, COUNT(*) as count 
    FROM jobs 
    WHERE status IN ('Starting', 'Running') 
    GROUP BY node_id
) running_jobs ON n.id = running_jobs.node_id
WHERE j.status = 'Waiting' 
AND n.status = 'Available'
AND COALESCE(running_jobs.count, 0) < n.max_concurrent
ORDER BY j.node_id, j.priority DESC, j.created_at ASC
```

### 3. ノード疎通確認・ヘルスチェック

#### 3.1 ノード追加時の初期疎通確認
- **タイミング**: ノード作成直後に即座に実行
- **初期状態**: 新規ノードは `status='unavailable'` で作成
- **確認内容**:
  1. SSH接続テスト (指定ポートへの接続)
  2. 基本コマンド実行 (`whoami`, `pwd` など)
  3. Abaqus実行環境確認 (`abaqus information=environment`)
- **成功時**: `status='available'` に更新
- **失敗時**: `status='unavailable'` のまま、エラーログ記録

#### 3.2 定期ヘルスチェック
- **対象**: `is_active=true` の全ノード
- **間隔**: 
  - **通常時**: 5分毎（300秒）
  - **障害検出時**: 1分毎（60秒）で3回リトライ
  - **復旧確認**: 30秒毎で復旧まで継続
- **確認内容**:
  1. SSH接続維持確認
  2. システム負荷チェック (`uptime`, `df -h`)
  3. Abaqusライセンス状況確認
  4. 実行中ジョブのプロセス確認
- **状態更新**:
  - 接続失敗 → `status='unavailable'`
  - 負荷上限到達 → `status='busy'`
  - 正常状態 → `status='available'`

#### 3.3 リアルタイム状態監視
- **ジョブ開始時**: ノード負荷状況を即座にチェック
- **ジョブ完了時**: リソース解放後に `status='available'` に更新
- **異常検出時**: 即座に `status='unavailable'` に変更

#### 3.4 手動接続テスト
- **管理画面**: 「接続テスト」ボタンでオンデマンド実行
- **用途**: ノード設定変更後の動作確認
- **結果**: リアルタイムで接続状況を表示

## ジョブライフサイクル

### 1. ステータス遷移

```
[新規作成]
    ↓
 Waiting ←─────────────┐
    ↓                 │
 Starting              │ (再試行時)
    ↓                 │
 Running               │
    ↓                 │
 Completed / Failed ───┘
    ↓
 [アーカイブ]
```

### 2. 各ステータスの詳細

#### Waiting
- 実行待ちキューに登録された状態
- スケジューラーによる割り当て待ち
- ユーザーによる手動キャンセル可能

#### Starting
- ノードに割り当てられ、実行準備中
- SSH接続、ディレクトリ準備、ファイル転送等
- 失敗時は Waiting に戻る

#### Running
- Abaqusプロセスが実行中
- 進捗情報をリアルタイム更新
- ユーザーによる停止要求可能

#### Completed
- 正常終了
- 結果ファイルを収集・保存
- ノードリソースを解放

#### Failed
- 異常終了またはエラー
- エラー情報を記録
- ノードリソースを解放

## 実行環境管理

### 1. 作業ディレクトリ

```
/abaqus/jobs/{job_id}/
├── input.inp          # アップロードされたINPファイル
├── job_{id}.sta       # ステータスファイル
├── job_{id}.dat       # データファイル
├── job_{id}.log       # ログファイル
├── job_{id}.msg       # メッセージファイル
└── results/           # 結果ファイル格納
```

### 2. ファイル管理

- **INPファイル**: ジョブ作成時にアップロード、各ノードに転送
- **結果ファイル**: 実行完了後に中央サーバーに収集
- **作業ファイル**: 実行中に生成、完了後に保持または削除
- **ログファイル**: 全て保存、トラブルシューティング用

## エラーハンドリング

### 1. 再試行戦略

| エラー種別 | 再試行回数 | 間隔 | 対応 |
|------------|------------|------|------|
| SSH接続失敗 | 3回 | 30秒 | ノードを一時的に無効化 |
| Abaqus実行エラー | 1回 | 60秒 | 別ノードで再実行 |
| ファイル転送失敗 | 2回 | 15秒 | ファイル再転送 |
| システムエラー | なし | - | 管理者通知 |

### 2. フェイルオーバー

- **ノード障害時**: 実行中ジョブを別ノードに移行
- **ネットワーク障害時**: 自動復旧を待機
- **Abaqusライセンス不足**: 待機キューで待機

## 監視・メトリクス

### 1. パフォーマンス指標

- **スループット**: 時間当たり完了ジョブ数
- **待機時間**: Waiting → Running の平均時間
- **実行時間**: Running → Completed の平均時間
- **成功率**: 完了ジョブ / 全ジョブ の比率

### 2. リソース使用率

- **ノード使用率**: 各ノードの稼働率
- **キュー長**: 待機中ジョブ数の推移
- **エラー率**: 失敗ジョブの比率

## 設定パラメータ

### 1. スケジューラー設定

```typescript
const SCHEDULER_CONFIG = {
    // ポーリング間隔（ミリ秒）
    POLL_INTERVAL: 5000,
    
    // エラー時の待機時間（ミリ秒）
    ERROR_BACKOFF: 10000,
    
    // 最大再試行回数
    MAX_RETRIES: 3,
    
    // ヘルスチェック間隔（ミリ秒）
    HEALTH_CHECK_INTERVAL: 60000,
    
    // ジョブタイムアウト（ミリ秒）
    JOB_TIMEOUT: 3600000, // 1時間
};
```

### 2. ノード設定

```typescript
const NODE_CONFIG = {
    // SSH接続タイムアウト（ミリ秒）
    SSH_TIMEOUT: 30000,
    
    // 最大同時実行ジョブ数（ノード毎）
    MAX_CONCURRENT_JOBS: 2,
    
    // ファイル転送タイムアウト（ミリ秒）
    FILE_TRANSFER_TIMEOUT: 300000, // 5分
};
```

## 運用・保守

### 1. ジョブキューの管理

- **手動優先度変更**: 緊急ジョブの優先実行
- **ジョブキャンセル**: 不要ジョブの削除
- **キュー停止/再開**: メンテナンス時の制御

### 2. ノード管理

- **ノード追加/削除**: 動的なリソース調整
- **メンテナンスモード**: 計画停止時の制御
- **負荷調整**: max_concurrent値の調整

### 3. ログ・デバッグ

- **実行ログ**: 全ジョブの実行履歴
- **エラーログ**: 失敗原因の詳細記録
- **パフォーマンスログ**: 処理時間の記録