# Abaqus ジョブ実行システム実装ガイド

## 📋 概要

このドキュメントは、Abaqus Job Managerにおけるジョブ実行システムの包括的な実装ガイドです。現在のシステムは「高機能なジョブ管理UI」として機能していますが、実際のAbaqusジョブ実行機能が未実装となっています。本ガイドでは、既存のインフラストラクチャを活用して完全なジョブ実行システムを構築する方法を詳述します。

## 🏗️ 現状分析

### ✅ 既存の強力なインフラストラクチャ

#### **1. Remote-pwsh ライブラリ**
- **場所**: `/app/app/lib/services/remote-pwsh/`
- **機能**: SSH/PowerShell実行システムの完全実装
- **構成要素**:
  - `executor.ts`: メイン実行エンジン
  - `types.ts`: TypeScript型定義
  - `events.ts`: イベント管理システム
  - `process.ts`: プロセス制御
  - `environment.ts`: 環境設定

#### **2. PowerShell スクリプト**
- **場所**: `/app/resources/ps-scripts/`
- **実装済みスクリプト**:
  - `executeAbaqus.ps1`: Abaqus実行（interactiveモード監視）
  - `sshRemoteSession.ps1`: SSH接続管理
  - `sendDirectory.ps1`: ノードへのディレクトリアップロード
  - `receiveDirectory.ps1`: ノードからのディレクトリダウンロード

#### **3. データベースシステム**
- **完全なCRUD操作**: 全エンティティ対応
- **ジョブステータス**: `waiting`, `starting`, `running`, `completed`, `failed`, `missing`
- **型安全性**: Zod + TypeScript完全実装

#### **4. SSE（Server-Sent Events）システム**
- **リアルタイム更新**: 完全実装
- **ジョブイベント**: `job_status_changed`, `job_created`, `job_deleted`
- **型安全性**: Channel-Event型マッピング

#### **5. UI コンポーネント**
- **ジョブ管理**: 作成・編集・削除・表示
- **ステータス表示**: リアルタイム更新対応
- **管理画面**: Admin機能完全実装

### 🚨 重要な未実装機能

#### **最重要ギャップ**: 自動ジョブ実行システム
- **現在**: ジョブの管理とUI操作は可能
- **未実装**: 実際のAbaqusコマンド実行
- **影響**: 「ジョブ管理UI」であり、実際のジョブ実行は不可

#### **手動実行テスト結果**
```powershell
# 手動実行で動作確認済み
pwsh resources/ps-scripts/sshRemoteSession.ps1 10.9.88.17 lab resources/ps-scripts/executeAbaqus.ps1 test "C:\temp\testjob" 2Dtest.inp cpu=2
```

## 🚀 実装計画（20ユーザー規模向け簡素化版）

### **Phase 1: シンプルなジョブ実行サービス（1週間）**

#### **1.1 AbaqusJobRunner - 統合ジョブ実行クラス**
- **場所**: `/app/app/lib/services/abaqus/abaqus-job-runner.server.ts`
- **目的**: 1つのクラスで完結するAbaqusジョブ実行システム
- **主要機能**:
  - 既存remote-pwsh executorとの統合
  - ジョブワークフロー: ファイル転送 → 実行 → 結果収集
  - **🚨 重要**: ファイル転送は**シリアル処理**を維持（リソース制約対応）
  - 基本的なステータス監視とデータベース更新
  - 既存PowerShellスクリプト活用
  - 簡単なエラーハンドリング

#### **統合される機能:**
- ファイル転送（シリアル処理）
- Abaqus実行（並列可能）
- 基本的なステータス監視
- データベース更新
- SSEイベント発信

### **Phase 2: 基本的なキューシステム（必要に応じて）**

#### **2.1 シンプルなジョブキュー**
- **場所**: 既存スケジューラーシステムを活用
- **目的**: 基本的なFIFOキューと並列実行制御
- **主要機能**:
  - 基本的なジョブキュー処理
  - 同時実行数制限（設定可能）
  - 基本的なリソース確認（CPUコア、ライセンス）
  - 失敗時の基本的なリトライ

### **Phase 3: 最小限の監視とUI（必要に応じて）**

#### **3.1 基本的な進捗表示**
- **場所**: 既存JobTableコンポーネント拡張
- **目的**: シンプルな進捗とステータス表示
- **主要機能**:
  - 基本ステータス（waiting/running/completed/failed）
  - 簡単な進捗表示
  - 基本的なエラー通知
  - 結果ファイルダウンロード

## 🔧 技術実装戦略

### **ファイル転送ワークフロー** 🚨 **シリアル処理要件**
1. **準備**: アプリケーションサーバー上でユニークなジョブディレクトリ作成
2. **アップロード**: `sendDirectory.ps1`でINPファイルをノード作業ディレクトリに転送（**シリアル**）
3. **実行**: interactiveモード監視で`executeAbaqus.ps1`実行（**並列可能**）
4. **ダウンロード**: `receiveDirectory.ps1`で結果ファイル収集（**シリアル**）
5. **クリーンアップ**: サーバーとノード両方の一時ディレクトリ削除

### **ジョブ実行ワークフロー** 🚨 **シリアル処理要件**
1. **キュー処理**: スケジューラーが`waiting`ステータスからジョブを選択
2. **リソースチェック**: ノード可用性とライセンストークン確認
3. **ファイル転送**: 選択ノードへのINPファイルアップロード（**シリアル**）
4. **実行**: interactiveモード監視でAbaqus開始（**並列可能**）
5. **監視**: 進捗とステータス更新のstdout解析（**並列可能**）
6. **収集**: 完了時の結果ファイルダウンロード（**シリアル**）
7. **クリーンアップ**: 一時ファイル削除とデータベース更新

### **🚨 重要: シリアル処理の必要性**
- **ネットワーク帯域制限**: 複数の大容量ファイル転送による帯域競合回避
- **ディスクI/O制限**: 同時ファイル操作によるI/Oボトルネック回避
- **SSH接続制限**: 同一ノードへの複数接続による競合回避
- **ストレージ容量**: 一時的な大容量ファイル蓄積による容量不足回避
- **エラー処理**: 転送エラーの原因特定と回復処理の簡素化

### **監視戦略**
- **第一**: interactiveモードリアルタイム stdout解析
- **第二**: 詳細進捗の.staファイル監視
- **エラー検出**: stdout, stderr, 終了コードの組み合わせ
- **フォールバック**: 基本ステータスの.lckファイル監視

### **アーキテクチャ統合**
- **既存remote-pwsh活用**: 実績あるSSH/PowerShell実行システム基盤
- **スケジューラーシステム使用**: 既存スケジューラーフレームワーク統合
- **SSEイベント拡張**: 既存SSEシステムへのジョブ実行イベント追加
- **データベース更新**: ステータス遷移での既存ジョブ操作使用
- **PowerShellスクリプト**: ファイル操作の既存実績スクリプト活用

## ⚠️ リスク軽減策

### **技術的リスク**
- **ネットワーク障害**: リトライロジックとコネクションプーリング実装
- **ファイル転送失敗**: ファイル整合性確認とリトライメカニズム
- **Abaqusエラー**: 包括的エラー解析と回復
- **リソース競合**: 適切なリソースロックと割り当て

### **運用リスク**
- **ジョブハング**: タイムアウトとヘルスチェック実装
- **ノード障害**: 他ノードへの自動フェイルオーバー
- **ライセンス枯渇**: キュー管理とリソース計画
- **ディスク容量**: 作業ディレクトリの監視と管理

## 📊 成功指標（簡素化版）

### **Phase 1 成功基準**
- [ ] 単一ジョブのエンドツーエンド実行（ファイル転送 + 実行 + 収集）
- [ ] ファイル転送のシリアル処理実装
- [ ] 基本的なステータス更新（waiting/running/completed/failed）
- [ ] 既存PowerShellスクリプト活用
- [ ] 基本的なエラーハンドリング

### **Phase 2 成功基準（必要に応じて）**
- [ ] 複数ジョブのキュー処理
- [ ] 基本的なリソース確認（CPUコア、ライセンス）
- [ ] 同時実行数制限

### **Phase 3 成功基準（必要に応じて）**
- [ ] 基本的な進捗表示
- [ ] 結果ファイルダウンロード
- [ ] エラー通知

## 📅 実装順序（簡素化版）

### **最優先（Phase 1）**
1. **AbaqusJobRunner** - 統合ジョブ実行クラス（1つのファイル）
   - ファイル転送（シリアル処理）
   - Abaqus実行
   - 基本的なステータス監視
   - データベース更新
   - SSEイベント発信

### **必要に応じて（Phase 2-3）**
2. **基本的なキューシステム** - 既存スケジューラー活用
3. **最小限のUI改善** - 既存コンポーネント拡張

## 🎯 期待される結果（簡素化版）

この簡素化された実装により、現在の「高機能なジョブ管理UI」が実用的な「Abaqusジョブ実行システム」に変貌します。**20ユーザー規模のLAN環境に最適化**され、既存インフラストラクチャを最大限活用します。

### **変換後のシステム能力**
- ✅ **UI・管理機能**: 完全動作（変更なし）
- ✅ **データベース**: 完全実装（変更なし）
- ✅ **リアルタイム更新**: 完全実装（変更なし）
- ✅ **ジョブ実行**: シンプルで実用的な実装（新規）
- ✅ **ファイル転送**: シリアル処理実装（新規）
- ✅ **基本的な監視**: 必要最小限の実装（新規）

### **簡素化による利点**
- **実装時間**: 4週間 → 1週間
- **保守性**: 1つのクラスで完結
- **運用の簡素化**: 複雑な設定不要
- **トラブルシューティング**: 問題の特定が容易
- **拡張性**: 必要に応じて段階的に機能追加可能

**最終状態**: "実用的なAbaqusジョブ実行システム"（20ユーザー規模に最適化）